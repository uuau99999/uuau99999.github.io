<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Hoyup,uuau99999@gmail.com"><meta name="copyright" content="Hoyup"><title>Stay awesome | Hoyup's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?be487d8575ef4be7f18a9c96d00c8dfd";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-119396317-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/6498327"></div><div class="author-info__name text-center">Hoyup</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/uuau99999">Follow me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/i_dont_wanna_use_default_archives"><span class="pull-left">Articles</span><span class="pull-right">6</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">8</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">1</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Hoyup's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Hoyup's Blog</div><div id="site-sub-title">Stay awesome</div><div id="site-social-icons"><a class="social-icon" href="https://github.com/uuau99999"><i class="fa-github fa"></i></a></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/29/Something-About-Babel/">Something About Babel</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-29</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Babel/">Babel</a></span><div class="content"><h2 id="关于-Babel-全家桶的理解"><a href="#关于-Babel-全家桶的理解" class="headerlink" title="关于 Babel 全家桶的理解"></a>关于 Babel 全家桶的理解</h2><p>最近在研究公司一些公用库打包问题，尤其是关于如何减小包的体积思考了很久。加上自己之前一直对 babel 打包全家桶不是特别理解，故结合了掘金上面的几篇文章，在这里自己总结一下。</p>
<h3 id="首先谈谈-babel-各全家桶的作用"><a href="#首先谈谈-babel-各全家桶的作用" class="headerlink" title="首先谈谈 babel 各全家桶的作用"></a>首先谈谈 babel 各全家桶的作用</h3><ul>
<li><p>@babel/core<br>babel 的核心库，在 v7 以前版本叫 babel-core(其他的库也类似)，内置提供了 babel 的编译方法，如 transformFile, transformFileSync，调用后可得到根据特定 babel 配置的转译后代码，ast 等。</p>
</li>
<li><p>@babel/cli<br>babel 的命令行工具，提供了在命令行中执行 babel 转译方法的指令。如</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx babel <span class="keyword">script</span>.js <span class="comment">--out-file script-compiled.js</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>babel-loader<br> 提供一个在 webpack 中进行 babel 编译的 loader，如在 webpack.config.js 中配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	rules: [</span><br><span class="line">		<span class="comment">// the 'transform-runtime' plugin tells Babel to</span></span><br><span class="line">		<span class="comment">// require the runtime instead of inlining it.</span></span><br><span class="line">		&#123;</span><br><span class="line">			test: <span class="regexp">/\.m?js$/</span>,</span><br><span class="line">			exclude: <span class="regexp">/(node_modules|bower_components)/</span>,</span><br><span class="line">			use: &#123;</span><br><span class="line">				loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">				options: &#123;</span><br><span class="line">					presets: [<span class="string">'@babel/preset-env'</span>],</span><br><span class="line">					plugins: [<span class="string">'@babel/plugin-transform-runtime'</span>]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>@babel/polyfill<br>我们知道 babel 默认只会转换语法规范，不会在代码中注入新特性中的 API。如在 es6 中的 Object.assign 方法，babel 默认是不做任何处理的。这时候就需要引入 polyfill，就是垫片。只要在代码入口的地方引入@babel-polyfill，就会把@babel-polyfill 所有提供的垫片引进来。这样的问题是会使得代码体积大很多，所以不推荐在库中使用 polyfill。<br>我们看最新版本的 polyfill 其实代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'core-js/stable'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'regenerator-runtime/runtime'</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到其实@babel/polyfill 就是由 core-js 和 regenerator-runtime 组成的，core-js 提供了所有 API 的垫片，regenerator-runtime 提供了对 async/await 语法转化的 helper 支持。<br>@babel/polyfill 在 7.4.4 版本后已经被官方 deprecated，官方推荐使用 core-js@3 + @babel/preset-env，其中配置 preset-env 的 corejs 版本为 3。</p>
</li>
<li><p>@babel/preset-env<br> 相信这个是很多主流项目在安装 babel 后第一个要使用的库。我们知道在 babel 的配置文件中可以使用很多插件来转译特定语法，如@babel/plugin-destructuring, @babel/plugin-arrow-functions，如果每次都安装这些插件很繁琐，所以 babel 还有一种叫 preset 的东西，把一套插件组合起来，就叫成 preset，如@babel/preset-react，@babel/preset-es2015。<br> 上面说到的 preset,plugin 都是在确定了在项目中需要支持哪些特定的语法后使用的。但这样会存在一个问题，我们用上面的配置生成出来的编译后代码可能在我们的目标浏览器中可能很多是不必要的，如我们的目标浏览器是 chrome，那我们就可以不用转译包括箭头函数在内的绝大部分 es6 的特性。用 babel 这样编译后使得代码体积大了不少。存在很大部分的浪费。那我们有没有可能根据目标浏览器自动选择需要哪些 plugin 呢？<br> 答案就是 preset-env。如名字所示，它可以根据你设置的目标浏览器环境自动选择哪些 plugin。如在.babelrc 或者 webpack 中配置:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">      [<span class="string">"env"</span>, &#123;</span><br><span class="line">          <span class="string">"targets"</span>: &#123;</span><br><span class="line">              <span class="string">"browsers"</span>: [<span class="string">"last 2 versions"</span>, <span class="string">"safari &gt;= 7"</span>]</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外需要提及的是 preset 关于垫片引入的 useBuiltIns 三种配置：false, entry, usage。false 则只做语法转化，不会处理任何 API 的垫片问题，entry 是在入口处引入所有的垫片，usage 是根据代码中使用到的垫片按需引入。由于 Babel &gt; 7.4.0 后，官方不推荐使用@babel/polyfill，如果需要垫片则要自己安装 core-js 然后设置 useBuiltIns 为 entry 或者 usage，同时指定 corejs 版本（默认为 2）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">      [<span class="string">"env"</span>, &#123;</span><br><span class="line">          <span class="string">"targets"</span>: &#123;</span><br><span class="line">              <span class="string">"browsers"</span>: [<span class="string">"last 2 versions"</span>, <span class="string">"safari &gt;= 7"</span>]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"useBuiltIns"</span>: <span class="string">"usage"</span>,</span><br><span class="line">          <span class="string">"corejs"</span>: <span class="number">3</span></span><br><span class="line">      &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的配置解决了垫片的问题，但还缺少了对于 async/await 语法的兼容。只用上面的配置，没有引入别的 polyfill, 若代码中使用了 async/await 语法，会报错，因为我们没有引入 regenerator-runtime。上面说到，@babel/polyfill 是由 core-js 和 regenerator-runtime 组成的，其实 regenerator-runtime 就是提供了 async/await 语法的 helper 方法。若缺少会导致 babel 编译出来的代码运行有问题。当然我不推荐在代码中直接引入 regenerator-runtime，我们有更优雅的方案。请接着看完。</p>
</li>
<li><p>@babel/plugin-transform-runtime, @babel/runtime<br> 我们知道 babel 在编译过程中主要会处理这几样事情：</p>
<ul>
<li>语法规范的转换，如 es6 中的 class, 箭头函数等</li>
<li>垫片处理，如 Object.assign, Array.includes 等</li>
<li>async/await 语法转换</li>
</ul>
<p>babel 在转化过程中会创建很多的 helper 方法，如果我们在不同的文件中使用这种需要转化的代码，就会创建很多重复的 helper 方法，这无疑会使我们的代码体积大很多。那我们是不是可以把这些共有的 helper 方法抽离出来呢？transform-runtime 就是做这个事情。另外我们还需要安装@babel/runtime。</p>
<p>@babel/runtime 里面包含了：</p>
<ul>
<li>core-js 引用（垫片的转化）</li>
<li>通用的 helper 方法（class，箭头函数等语法）</li>
<li>regenerator-runtime 引用（async/await 语法的 helper 方法）</li>
</ul>
<p>transform-runtime 会把在转译过程中需要用到 helper 方法的地方改为引入@babel/runtime 里面的方法，这样就可以避免创建重复的 helper 方法。贴一段代码帮助理解吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>(x, y) &#123;</span><br><span class="line">		<span class="keyword">this</span>.x = x;</span><br><span class="line">		<span class="keyword">this</span>.y = y;</span><br><span class="line">	&#125;</span><br><span class="line">	getX() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.x;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> cp = <span class="keyword">new</span> ColorPoint(<span class="number">25</span>, <span class="number">8</span>);</span><br><span class="line"><span class="comment">// -----------------------------</span></span><br><span class="line"><span class="comment">// 编译后</span></span><br><span class="line">(<span class="string">'use strict'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'core-js/modules/es.object.define-property'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_classCallCheck</span>(<span class="params">instance, Constructor</span>) </span>&#123;</span><br><span class="line">	<span class="comment">/* 省略... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_defineProperties</span>(<span class="params">target, props</span>) </span>&#123;</span><br><span class="line">	<span class="comment">/* 省略... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createClass</span>(<span class="params">Constructor, protoProps, staticProps</span>) </span>&#123;</span><br><span class="line">	<span class="comment">/* 省略... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> Point = <span class="comment">/*#__PURE__*/</span> (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">		_classCallCheck(<span class="keyword">this</span>, Point);</span><br><span class="line">		<span class="keyword">this</span>.x = x;</span><br><span class="line">		<span class="keyword">this</span>.y = y;</span><br><span class="line">	&#125;</span><br><span class="line">	_createClass(Point, [</span><br><span class="line">		&#123;</span><br><span class="line">			key: <span class="string">'getX'</span>,</span><br><span class="line">			value: <span class="function"><span class="keyword">function</span> <span class="title">getX</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.x;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]);</span><br><span class="line">	<span class="keyword">return</span> Point;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">var</span> cp = <span class="keyword">new</span> ColorPoint(<span class="number">25</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>
<p>使用 transform-runtime 后：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> _interopRequireDefault = <span class="built_in">require</span>(<span class="string">'@babel/runtime/helpers/interopRequireDefault'</span>);</span><br><span class="line"><span class="keyword">var</span> _classCallCheck2 = _interopRequireDefault(</span><br><span class="line">	<span class="built_in">require</span>(<span class="string">'@babel/runtime/helpers/classCallCheck'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> _createClass2 = _interopRequireDefault(</span><br><span class="line">	<span class="built_in">require</span>(<span class="string">'@babel/runtime/helpers/createClass'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> Point = <span class="comment">/*#__PURE__*/</span> (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">Point</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">		(<span class="number">0</span>, _classCallCheck2.default)(<span class="keyword">this</span>, Point);</span><br><span class="line">		<span class="keyword">this</span>.x = x;</span><br><span class="line">		<span class="keyword">this</span>.y = y;</span><br><span class="line">	&#125;</span><br><span class="line">	(<span class="number">0</span>, _createClass2.default)(Point, [</span><br><span class="line">		&#123;</span><br><span class="line">			key: <span class="string">'getX'</span>,</span><br><span class="line">			value: <span class="function"><span class="keyword">function</span> <span class="title">getX</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>.x;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]);</span><br><span class="line">	<span class="keyword">return</span> Point;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">var</span> cp = <span class="keyword">new</span> ColorPoint(<span class="number">25</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>
<p>另外使用 transform-runtime 替换 polyfill 的好处是避免全局污染。polyfill 会直接修改原型，如果项目用到第三方库可能会有问题。使用 transform-runtime 则是使用 helper 方法，不会污染全局。</p>
</li>
</ul>
<h3 id="如何在编写库时正确使用-babel-配置"><a href="#如何在编写库时正确使用-babel-配置" class="headerlink" title="如何在编写库时正确使用 babel 配置"></a>如何在编写库时正确使用 babel 配置</h3><ul>
<li>不使用 polyfill。<br>为了减少打包体积，把整个 polyfill 包（大概 87k）引入进来肯定是不现实的。你会说如果我是给自己的项目用，我在自己项目中引入 polyfill，库本身不引用不就好了。这当然是可以，但不方便你开发测试这个库。因为你需要依赖宿主环境。<br>建议使用@babel/runtime + @babel/plugin-transform-runtime。</li>
<li>使用@babel/plugin-transform-runtime<br>上面介绍 babel 全家桶也说过了，使用 transform-runtime 可以减小打包体积，因为除了可以抽离库本身用到的 helper 方法/core-js 引用/regenerator-runtime 等（要注意宿主项目需要安装@babel/runtime），还可以和宿主项目共享@babel/runtime 里面的方法。但不绝对，如果你只有一个文件，且用到的新特性不多，那 helper 方法也不会太多，没有必要使用 transform-runtime。</li>
<li>在特定环境下把库使用的第三方库 external 出去<br>比如你要开发一个 vue 的组件库，你的库中引用了 vue，但打包时候可以把 vue external 出去。因为你能确定在宿主项目中肯定包含了 vue 的依赖。不需要重复打包在库里面了。</li>
<li>构建出来 target 优先使用 esmodule<br>webpack4 以后支持了编译时的 tree shaking。而且 webpack 的 tree shaking 只支持 es6 的 module，所以打包出来的代码如果是 esmodule，webpack 构建会只 bundle 目标库中你引用到的暴露出来的方法或者变量。</li>
</ul>

      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2020/02/29/Something-About-Babel/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/14/头条一道面试题-手写节流器/">头条一道面试题-手写节流器</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-14</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/节流器/">节流器</a></span><div class="content"><h2 id="论如何实现一个节流器"><a href="#论如何实现一个节流器" class="headerlink" title="论如何实现一个节流器"></a>论如何实现一个节流器</h2><hr>
<p> 在这里分享一个之前头条的面试手写代码题目，题目很简单，如何自己实现一个节流器，要求400ms最多执行一次，且如果400ms内触发超过1次则当前400ms后再立即触发一次</p>
<p> 如果是普通的节流器实现还是相对简单的，之前看过debounce的写法，遇到这个不知道怎么实现超过1次400ms后要立即执行一次，吃了大亏。。最后还是在面试官提醒下才写出来，丢脸。。</p>
<p> 代码如下：<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> context = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> timer;</span><br><span class="line">    <span class="keyword">var</span> last = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">        <span class="keyword">var</span> interval = now - last;</span><br><span class="line">        <span class="keyword">var</span> next = <span class="built_in">Math</span>.max(<span class="number">0</span>, <span class="number">400</span> - interval);</span><br><span class="line">        <span class="keyword">if</span>(timer) &#123;</span><br><span class="line">            clearTimeout(timer);</span><br><span class="line">            timer = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            fn.apply(context, <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">0</span>));</span><br><span class="line">            last = now;</span><br><span class="line">            timer = <span class="literal">null</span>;</span><br><span class="line">        &#125;, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 当然还可以再改进一下，上面的代码存在一个问题就是在没有超出调用次数时不能保证立即触发，因为会进入到timeout队列。这里可以判断下次时间是为0则立即触发，代码就不写了- -</p>

      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2019/03/14/头条一道面试题-手写节流器/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/12/12/h5常见问题汇总/">h5常见问题汇总（持续更新）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-12-12</time><div class="content"><hr>
<h2 id="ios设置右键菜单禁用会导致input输入框无法输入（但键盘能正常弹出）"><a href="#ios设置右键菜单禁用会导致input输入框无法输入（但键盘能正常弹出）" class="headerlink" title="ios设置右键菜单禁用会导致input输入框无法输入（但键盘能正常弹出）"></a>ios设置右键菜单禁用会导致input输入框无法输入（但键盘能正常弹出）</h2> <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="comment">/*webkit浏览器*/</span></span><br><span class="line">    <span class="attribute">-khtml-user-select</span>: none;</span><br><span class="line">    <span class="comment">/*早期浏览器*/</span></span><br><span class="line">    <span class="attribute">-moz-user-select</span>: none;</span><br><span class="line">    <span class="comment">/*火狐*/</span></span><br><span class="line">    <span class="attribute">-ms-user-select</span>: none;</span><br><span class="line">    <span class="comment">/*IE10*/</span></span><br><span class="line">    <span class="attribute">user-select</span>: none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*<span class="selector-pseudo">:not(input</span>, <span class="selector-tag">textarea</span>) &#123;</span><br><span class="line">    <span class="attribute">-webkit-touch-callout</span>: none;</span><br><span class="line">    <span class="comment">/*系统默认菜单被禁用*/</span></span><br><span class="line">    <span class="attribute">-webkit-user-select</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="safari禁用focus-button边框高亮与ios-touch高亮"><a href="#safari禁用focus-button边框高亮与ios-touch高亮" class="headerlink" title="safari禁用focus button边框高亮与ios touch高亮"></a>safari禁用focus button边框高亮与ios touch高亮</h2><p> css代码如下<br> <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*禁用ios点击高亮 */</span></span><br><span class="line">-webkit-tap-highlight-<span class="attribute">color</span>: transparent;</span><br><span class="line"><span class="comment">/*禁用safari focus高亮*/</span></span><br><span class="line"><span class="attribute">outline</span>: none;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="ios10-button-flex布局-justify-content无效"><a href="#ios10-button-flex布局-justify-content无效" class="headerlink" title="ios10 button flex布局 justify-content无效"></a>ios10 button flex布局 justify-content无效</h2><p> 可以用一个非button的tag包裹，并对其用flex布局</p>
<h2 id="ios-自定义modal-滚动穿透"><a href="#ios-自定义modal-滚动穿透" class="headerlink" title="ios 自定义modal 滚动穿透"></a>ios 自定义modal 滚动穿透</h2><p> 如果modal样式如下：<br> <figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.modal</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: rgba(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 这样的modal出现后如果原本父级可以scroll会导致滚动穿透（即modal不动，但父级图层可以滑动）<br> 解决方案是css结合js，首先当modal出现时给body设置position :fixed，但这样会导致窗口scroll位置回到顶部，这时候要给body设置原来scroll位置的一个top负值。代码如下：<br> <figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public handleOpenModal = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.scrollTop = <span class="built_in">document</span>.body.scrollTop || <span class="built_in">document</span>.documentElement!.scrollTop;</span><br><span class="line">  <span class="built_in">document</span>.body.style.cssText += <span class="string">'position:fixed;top:-'</span> + <span class="keyword">this</span>.scrollTop + <span class="string">'px;'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">public handleCloseModal = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>.body.style.position = <span class="string">''</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.style.top = <span class="string">''</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.scrollTop = <span class="keyword">this</span>.scrollTop;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">    <span class="built_in">document</span>.documentElement.scrollTop = <span class="keyword">this</span>.scrollTop;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="这个方法也不完美。经实测在ios刘海屏里对body应用position-fixed会使底部出现safearea的padding顶上来。"><a href="#这个方法也不完美。经实测在ios刘海屏里对body应用position-fixed会使底部出现safearea的padding顶上来。" class="headerlink" title=" 这个方法也不完美。经实测在ios刘海屏里对body应用position fixed会使底部出现safearea的padding顶上来。"></a> 这个方法也不完美。经实测在ios刘海屏里对body应用position fixed会使底部出现safearea的padding顶上来。</h2><h2 id="设置文本input的placeholder样式-sass"><a href="#设置文本input的placeholder样式-sass" class="headerlink" title="设置文本input的placeholder样式(sass)"></a>设置文本input的placeholder样式(sass)</h2> <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">   <span class="variable">@mixin</span> car-number-placeholder &#123;</span><br><span class="line">       <span class="symbol">color:</span> <span class="comment">#64646A;</span></span><br><span class="line">       <span class="symbol">opacity:</span> <span class="number">0</span>.<span class="number">16</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &amp;<span class="symbol">:</span><span class="symbol">:-moz-placeholder</span> &#123;</span><br><span class="line">       <span class="variable">@include</span> car-number-placeholder;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &amp;<span class="symbol">:</span><span class="symbol">:-webkit-input-placeholder</span> &#123;</span><br><span class="line">       <span class="variable">@include</span> car-number-placeholder;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &amp;<span class="symbol">:-ms-input-placeholder</span> &#123;</span><br><span class="line">       <span class="variable">@include</span> car-number-placeholder;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ios-input框placeholder无法垂直居中"><a href="#ios-input框placeholder无法垂直居中" class="headerlink" title="ios input框placeholder无法垂直居中"></a>ios input框placeholder无法垂直居中</h2><p> 设置 line-height: normal;</p>
<hr>
<h2 id="react-router-v4-在静态资源服务器下使用-BrowserRouter-会导致白屏无法渲染"><a href="#react-router-v4-在静态资源服务器下使用-BrowserRouter-会导致白屏无法渲染" class="headerlink" title="react-router(v4) 在静态资源服务器下使用 BrowserRouter 会导致白屏无法渲染"></a>react-router(v4) 在静态资源服务器下使用 BrowserRouter 会导致白屏无法渲染</h2><p> 改用 HashRouter</p>
<hr>
<h2 id="ios10的flex布局的div如果没有设置高度（如通过flex或者100-指定高度），子div高度100-无效"><a href="#ios10的flex布局的div如果没有设置高度（如通过flex或者100-指定高度），子div高度100-无效" class="headerlink" title="ios10的flex布局的div如果没有设置高度（如通过flex或者100%指定高度），子div高度100%无效"></a>ios10的flex布局的div如果没有设置高度（如通过flex或者100%指定高度），子div高度100%无效</h2><p> 对父div设置固定高度或者子div设置固定高度</p>
<hr>
<h2 id="ios11-12遇到刘海屏会webview会默认对其设置一个safearea的padding-bottom"><a href="#ios11-12遇到刘海屏会webview会默认对其设置一个safearea的padding-bottom" class="headerlink" title="ios11,12遇到刘海屏会webview会默认对其设置一个safearea的padding-bottom"></a>ios11,12遇到刘海屏会webview会默认对其设置一个safearea的padding-bottom</h2><p> 要使屏幕底部的padding消失需要在meta的viewport设置 viewport-fit=cover</p>
<hr>
<h2 id="ios对body设置position-fixed-要慎用"><a href="#ios对body设置position-fixed-要慎用" class="headerlink" title="ios对body设置position: fixed;要慎用"></a>ios对body设置position: fixed;要慎用</h2><p> 这样设置样式会在ios下有两个问题：<br> 1）底部设置的viewport-fit=cover失效，即底部会出现safe-area的padding-bottom<br> 2）input框初始点击能唤起键盘，点击完成后点击键盘不能唤起，需要长按或多次点击才能唤起</p>
<hr>
<h2 id="ios-设置-input-placeholder-垂直居中"><a href="#ios-设置-input-placeholder-垂直居中" class="headerlink" title="ios 设置 input placeholder 垂直居中"></a>ios 设置 input placeholder 垂直居中</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">line</span>-<span class="built_in">height</span>: <span class="built_in">normal</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="iOS-10-fetch-需要polyfill"><a href="#iOS-10-fetch-需要polyfill" class="headerlink" title="iOS 10 fetch 需要polyfill"></a>iOS 10 fetch 需要polyfill</h2><hr>
<h2 id="部分Android手机-小米，oppo-不支持history-go-慎用"><a href="#部分Android手机-小米，oppo-不支持history-go-慎用" class="headerlink" title="部分Android手机(小米，oppo)不支持history.go(),慎用"></a>部分Android手机(小米，oppo)不支持history.go(),慎用</h2>
      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2018/12/12/h5常见问题汇总/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/09/06/2018蚂蚁前端社招面经/">2018蚂蚁前端社招面经</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-06</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/前端/">前端</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/蚂蚁金服/">蚂蚁金服</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/面经/">面经</a></span><div class="content"><p>上周一位去蚂蚁的前同事发了蚂蚁的Alipay HK的前端岗位的内推给我，趁着最近进度不是很赶就投了简历。大概一个星期后的昨晚接到了电面。<br>一面的面试官还是很nice的，声音听上去挺年轻的。面试一开始面试官主要是结合你的项目问你所使用的技术，项目的背景，以及你在项目中的职责。不会问太多关于技术的细节。由于我之前主要是用RN做App的，但是他们的团队貌似是用Native+web混合开发，不存在使用RN或者是Weex这种技术。当然一开始他也问我为什么不用阿里的Weex。我说Weex文档写的不健全社区也不活跃，而且之前我们团队有用react做过web基于同样的技术栈所以选择了RN。并且国内Weex貌似除了阿里以外没什么公司会用。然后面试官尴尬的笑着说其实他们自己也不用的- -。</p>
<p>接下来他让我挑几个我觉得有亮点的项目跟他讲解一下。我就主要讲了之前用Cordova/Ionic做的一个Hybrid的App，后面由于性能原因升级到React Native。他问我们的性能是用什么量化指标去评估的，我也不知道怎么回答就说业务觉得界面开始有点卡而且在外包咨询公司的怂恿下决定升级到RN。。。然后他问那你们在项目中有做过哪些优化，性能，代码，重构都可以。我就把react里面的一些最佳实践说了一下，如对于复杂state的容器使用shouldComponentUpdate去做一层判断，当然我们一般很懒都直接用react-redux的connect方法用redux自带的shouldComponentUpdate去优化性能。除此以外也通过大量的pure component保证了底层的组件不会过多重复渲染。还有就是关于RN的列表，flatlist使用的VirtualizedList通过延迟渲染避免了列表长度大加载卡顿的情况。<br>后面我也跟他说了我用websocket做了一套运行在RN上面的实时推送功能。这时候面试官就大概问了一下我是怎么管理这个node服务的，比如怎么监控，负载怎么做的，单机并发多少。我就说公司有paas平台会对服务进行监控，多实例负载也是paas上做的。我同时用了cluster在一个实例上fork多个线程用Round-Robin算法来充分利用多核性能去做负载。压测单机并发可稳定在30k左右。接下来就是问的关于安全的问题。比如你们App怎么做授权的。怎么保证安全。我说我们通过token来和服务器交互，token是加密存储在keysotre/SE中的。对于敏感操作有短信的二次验证来保证安全。接着他又问那你们有没用过一些在客户端本地验证token的方法，我回答jwt算吗。他说也算。那jwt有什么优势和劣势呢。我说优势是可以做分布式的权限校验，而且token中带有用户基本信息不需要再向服务器发请求确定用户身份。jwt还可以用来做单点登录。jwt劣势在于它的验证机制是基于签名的。一旦token泄露后端也没有方法取消对这个token的授权。面试官说那有没方法呢。我说就只能在服务端存储关于token的记录。当验证token的时候除了校验签名还要去保证服务端这边是有对应的。但如果这个好像就没必要用jwt了- -。后面还问了关于csrf、xss的防范。</p>
<p>除了上面这些还问了我关于前端构建工具的选择和搭建，同时也问我更趋向做web前端还是Native。我说更趋向web，也想做Node。他说他们那里Node的应用还是很多的。然后问我有什么问题。我就问了一下他们那边的业务背景、技术栈和工程实践，大致了解了一下。<br>一面大概持续了40分钟。强度不是特别高。面试官也比较有耐心。</p>
<p>然后今天中午就收到下午两点二面的通知。心想我靠这么频繁的吗。都没时间准备。</p>
<p>二面基本就是被打击了。。。</p>
<p>跟一面不一样，二面的面试官听上去明显就更年长一下，应该是技术主管之类的。一开始也是问了我们是怎么做技术选型的。我扯了一堆理由后面试官就开始问一些深入的问题了，比如你用到了websocket，那websocket的报文格式有了解吗，用的是http还是tcp，跟http有什么关系，http的keep-alive跟websocket有什么不一样呢。。。然后又问你们node服务是部署在linux上的吧，那底层连接怎么管理的呢，了解e-poll吗，有了解过http2吗。这些我基本都答不上来，然后他说看来你还是在应用级别，没有考虑过它有一天崩了怎么处理呢。。。<br>接下来换了个方向，关于react的。如为什么react有virtual dom呢。dom diff算法是怎么样的呢。自己用算法描述react的dom diff算法。了解受控组件和非受控组件吗。这些我只能回答一些比较浅的。然后面试官也很耐心，答不上来就尴尬的笑了换下一个问题。<br>后面是js基础。关于闭包，以及原理，（如闭包为什么不会释放，内存gc算法，我只回答了引用计数，标记清除竟然忘了。。）知道严格模式吗，跟非严格模式有什么区别。如何在js实现继承对象属性（我说用__proto__指向目标的原型对象，他问有没正规的用法，我说好像有个Object.setPrototypeOf的方法。。。），如何实现迭代器，ES6新增的for of怎么用的，跟for in 的区别。js有哪些基本类型。number精度多少，settimeout为什么会有延迟误差，怎么实现跨域。这些基本都回答上来了。他说我js基础还行。但有些知识还是要去补习了解一下。<br>最后面试官还怕我哪些特长他忽略了没有问我，我说应该没有了哈哈- -。最后也是他对我进行了一些简单点评。他说我定位有点模糊。前端和node都不是特别专。而阿里倾向于招专才，或者是全才，但必须在某方面要特别突出的。<br>二面持续了大概一个小时。说的我口都干了。。也心疼面试官，感觉他后面应该很无奈了- -</p>
<p>感觉自己应该跪在二面了。其实自己也没有充分准备，只是想投着看看。这次面试给我的收获也是很大的。我也发现了平时很多没有去仔细研究的地方。搞技术不是只会用框架，应该花时间去了解他的原理。另外要对自己的发展有明确方向。你不可能所有方面都很突出，必须要在某方面建立自己的优势。</p>
<p>嗯。努力吧。明年的自己肯定又不一样了。</p>

      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2018/09/06/2018蚂蚁前端社招面经/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/05/17/关于react-navigation-点击过快出现dulplicate路由的解决方案/">关于react-navigation 点击过快出现dulplicate路由的解决方案</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/react-native/">react native</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/react-navigation/">react navigation</a></span><div class="content"><p>最近做的几个react native 项目都用到了 react navigation 这个路由框架。react navigation 这个框架有着堪称原生性能的路由框架在发布不久就基本把RN其他框架给比下去了。它功能非常强大，可配置性很高，虽然一开始上手会有点困难但熟练后简直是路由神器。不过最近我发现一个问题，当你点击跳转路由按键过快会导致重复弹出相同的路由，这简直不能忍。这算不算点击穿透？令我惊讶的是react navigation 官方团队竟然到现在还没解决这个问题。。。</p>
<p>我后来在网上看到不少人都遇到这个问题，主要有以下2种解决方案：</p>
<ol>
<li><p>通过debounce方式，即通过setTimeout方法，当用户点击跳转路由按钮就给点击事件设置一个setTimeout事件，通过一个状态位把这个按钮的响应在接下来几秒内屏蔽掉。  </p>
 <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this.<span class="keyword">state</span>.disabled = true</span><br><span class="line"><span class="built_in">set</span>Timeout(() =&gt; &#123;  </span><br><span class="line">    this.<span class="keyword">state</span>.disabled = false)  </span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>
<p> 这种方法需要在所以点击事件注入这段代码，既不优雅且维护成本高。没有采用这种方案。  </p>
</li>
</ol>
<ol start="2">
<li><p>如果你的项目引用了redux 并集成了 react navigation， 可以用下面这种方案：  </p>
<p> 按照react navigation官方集成教学，你的路由的reducer应该是这个样子的：</p>
 <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import Router <span class="keyword">from</span> '../../components/Router'</span><br><span class="line">const navReducer = (<span class="keyword">state</span>, action) =&gt; &#123;</span><br><span class="line">    const newState = Router.router.getStateForAction(action, <span class="keyword">state</span>);</span><br><span class="line">    return newState || <span class="keyword">state</span>;</span><br><span class="line">&#125;</span><br><span class="line">export <span class="keyword">default</span> navReducer</span><br></pre></td></tr></table></figure>
<p> 我们要改动的，就是这个reducer。其实就是覆写react navigation关于路由state计算的逻辑。在默认情况下，我们用了react navigation 提供的Router.router.getStateForAction 方法去根据当前state和action算出下一步的state。这里state的变化会对应我们的路由栈。如果我们想要防止上面说的多次点击出现重复的路由，就需要在计算路由变化时，判断下一步action的跳转路由是不是跟当前一致，如果是则直接返回当前state，否则就使用Router.router.getStateForAction 计算state并返回。代码如下：</p>
 <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import Router <span class="keyword">from</span> '../../components/Router'</span><br><span class="line"></span><br><span class="line">function _getCurrentRoute(navState) &#123;</span><br><span class="line">    if (navState.hasOwnProperty('index')) &#123;</span><br><span class="line">        return _getCurrentRoute(navState.routes[navState.index])</span><br><span class="line">    &#125;</span><br><span class="line">    return navState</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const reducer = (<span class="keyword">state</span>, action) =&gt; &#123;</span><br><span class="line">    const &#123; type, routeName &#125; = action</span><br><span class="line">    if (type.startsWith('Navigation/')) &#123;</span><br><span class="line">        const lastRoute = _getCurrentRoute(<span class="keyword">state</span>)</span><br><span class="line">        if (routeName === lastRoute.routeName) &#123;</span><br><span class="line">            return <span class="keyword">state</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    const newState = Router.router.getStateForAction(action, <span class="keyword">state</span>)</span><br><span class="line">    if (newState) &#123;</span><br><span class="line">        newState.currentRoute = _getCurrentRoute(newState)</span><br><span class="line">    &#125;</span><br><span class="line">    return newState || <span class="keyword">state</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里通过一个_getCurrentRoute递归方法去找到当前的route，我算出来同时还把它放到了state里面的currentRoute，这样在别的地方也能通过redux 注入currentRoute获取到当前的route信息了。</p>
<hr>
<p> P.S.<br> 对于不使用redux的react navigation v2以上用户，可以用以下方法：<br> 在root component：</p>
 <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">constructor(props: <span class="literal">any</span>) &#123;</span><br><span class="line">    super(props);</span><br><span class="line">    this.AppNavigation = createNavigator(...);</span><br><span class="line">    this.AppNavigation.router.getStateForAction = navigateOnce(this.AppNavigation.router.getStateForAction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">    return <span class="variable">&lt;this.AppNavigation /&gt;</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">const navigateOnce = (getStateForAction: <span class="literal">any</span>) =&gt; (action: <span class="literal">any</span>, <span class="keyword">state</span>: <span class="literal">any</span>) =&gt; &#123;</span><br><span class="line">    const &#123; type, routeName &#125; = action;</span><br><span class="line">    if (</span><br><span class="line">      <span class="keyword">state</span> &amp;&amp;</span><br><span class="line">      (type === NavigationActions.NAVIGATE || type === StackActions.PUSH) &amp;&amp;</span><br><span class="line">      routeName === <span class="keyword">state</span>.routes[<span class="keyword">state</span>.routes.length - <span class="number">1</span>].routeName</span><br><span class="line">    ) &#123;</span><br><span class="line">      return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return getStateForAction(action, <span class="keyword">state</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ol>

      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2018/05/17/关于react-navigation-点击过快出现dulplicate路由的解决方案/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/05/15/first-post/">first post</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/new/">new</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/new-post/">new post</a></span><div class="content"><h3 id="花了大概1个小时终于搞定这个blog。hexo还是挺好用的。后面有文章都会post到这上面来。"><a href="#花了大概1个小时终于搞定这个blog。hexo还是挺好用的。后面有文章都会post到这上面来。" class="headerlink" title="花了大概1个小时终于搞定这个blog。hexo还是挺好用的。后面有文章都会post到这上面来。"></a>花了大概1个小时终于搞定这个blog。hexo还是挺好用的。后面有文章都会post到这上面来。</h3>
      <script>
        window.disqusProxy={
          shortname: 'uuau99999',
          username: 'uuau99999',
          server: 'disqus-proxy.ycwalker.com',
          port: 443,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2018/05/15/first-post/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script></div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Hoyup</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>